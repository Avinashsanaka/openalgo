{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Stock Screener</h1>

    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">VBL 20 EMA Scanner</h2>
            <p>Check if Varun Beverages Ltd (VBL) is trading above or below its 20-day Exponential Moving Average.</p>

            <div class="flex justify-end mt-4">
                <button id="scanBtn" class="btn btn-primary" onclick="runScan()">Run Scan</button>
            </div>

            <div id="resultArea" class="mt-6 hidden">
                <div class="overflow-x-auto">
                    <table class="table w-full">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Current Price</th>
                                <th>20 EMA</th>
                                <th>Signal</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody">
                            <!-- Results will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="loadingArea" class="mt-6 hidden flex justify-center">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
             <div id="errorArea" class="mt-6 hidden text-error">
            </div>

        </div>
    </div>
</div>

<script>
async function runScan() {
    const scanBtn = document.getElementById('scanBtn');
    const resultArea = document.getElementById('resultArea');
    const loadingArea = document.getElementById('loadingArea');
    const resultBody = document.getElementById('resultBody');
    const errorArea = document.getElementById('errorArea');

    scanBtn.disabled = true;
    resultArea.classList.add('hidden');
    errorArea.classList.add('hidden');
    loadingArea.classList.remove('hidden');

    try {
        const response = await fetch("{{ url_for('screener_bp.scan_vbl') }}");
        const data = await response.json();

        loadingArea.classList.add('hidden');
        scanBtn.disabled = false;

        if (data.status === 'success') {
            const row = data.data;
            const signalClass = row.signal.includes('ABOVE') ? 'text-success' : 'text-error';

            resultBody.innerHTML = `
                <tr>
                    <td class="font-bold">${row.symbol}</td>
                    <td>${row.current_price.toFixed(2)}</td>
                    <td>${row.ema_20.toFixed(2)}</td>
                    <td class="font-bold ${signalClass}">${row.signal}</td>
                    <td>${row.timestamp}</td>
                </tr>
            `;
            resultArea.classList.remove('hidden');
        } else {
             errorArea.textContent = "Error: " + data.message;
             errorArea.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error:', error);
        loadingArea.classList.add('hidden');
        scanBtn.disabled = false;
         errorArea.textContent = "An unexpected error occurred.";
         errorArea.classList.remove('hidden');
    }
}
</script>
{% endblock %}
