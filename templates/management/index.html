{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Position Management</h1>

    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title">Open Positions</h2>
                <button id="group-action-btn" class="btn btn-primary btn-sm hidden" onclick="openGroupModal()">
                    Create Group Rule (<span id="selected-count">0</span>)
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>
                                <label>
                                    <input type="checkbox" class="checkbox" onclick="toggleAll(this)" />
                                </label>
                            </th>
                            <th>Symbol</th>
                            <th>Product</th>
                            <th>Net Qty</th>
                            <th>LTP</th>
                            <th>PnL</th>
                            <th>Management Rules</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pos in positions %}
                        <tr>
                            <th>
                                <label>
                                    <input type="checkbox" class="checkbox pos-checkbox" value="{{ pos.symbol }}" onchange="updateSelection()" />
                                </label>
                            </th>
                            <td class="font-bold">{{ pos.symbol }}</td>
                            <td>{{ pos.product }}</td>
                            <td>{{ pos.netqty }}</td>
                            <td>{{ pos.lp }}</td>
                            <td class="{{ 'text-success' if pos.pnl|float > 0 else 'text-error' }}">{{ pos.pnl }}</td>
                            <td>
                                {% if pos.rule %}
                                    <div class="badge {{ 'badge-info' if pos.rule.is_active else 'badge-ghost' }} gap-2 h-auto py-1">
                                        {% if pos.rule.is_active %}
                                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse" title="Active"></span>
                                        {% else %}
                                            <span class="text-xs font-mono">[Inactive]</span>
                                        {% endif %}

                                        {% if pos.rule.is_group_rule %}
                                            <span class="font-bold text-warning" title="Group Rule">[G]</span>
                                        {% endif %}

                                        <span>
                                        {% if pos.rule.exit_type == 'TOTAL_LOSS' %}
                                            Loss: {{ pos.rule.max_loss }}
                                        {% elif pos.rule.exit_type == 'CANDLE_CLOSE' %}
                                            Candle Close
                                        {% endif %}

                                        {% if pos.rule.target_profit %}
                                            {% if pos.rule.exit_type != 'NONE' %}|{% endif %} Target: {{ pos.rule.target_profit }}
                                        {% endif %}
                                        </span>
                                    </div>
                                {% else %}
                                    <span class="text-gray-400 text-sm">None</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pos.rule %}
                                    <button class="btn btn-error btn-xs" onclick="deleteRule({{ pos.rule.id }})">Remove</button>
                                {% else %}
                                    <button class="btn btn-primary btn-xs" onclick="openRuleModal('{{ pos.symbol }}', '{{ pos.exchange }}', '{{ pos.product }}')">Add Rule</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center">No open positions found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Rule Modal -->
<dialog id="rule_modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg">Add Management Rule for <span id="modal_symbol"></span></h3>
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
    </form>

    <div class="form-control w-full max-w-xs mt-4">
        <label class="label">
            <span class="label-text">Exit Condition Type</span>
        </label>
        <select class="select select-bordered" id="exit_type" onchange="toggleInputs()">
            <option value="TOTAL_LOSS">Total Loss (Stop Loss)</option>
            <option value="CANDLE_CLOSE">Candle Close (20 EMA)</option>
        </select>
    </div>

    <div id="loss_input_div" class="form-control w-full max-w-xs mt-4">
        <label class="label">
            <span class="label-text">Max Loss Amount (Absolute)</span>
        </label>
        <input type="number" id="max_loss" placeholder="e.g. 5000" class="input input-bordered w-full max-w-xs" />
    </div>

    <div id="target_input_div" class="form-control w-full max-w-xs mt-4">
        <label class="label">
            <span class="label-text">Target Profit Amount</span>
        </label>
        <input type="number" id="target_profit" placeholder="e.g. 10000" class="input input-bordered w-full max-w-xs" />
    </div>

    <div class="form-control w-full max-w-xs mt-4" id="group_checkbox_div">
        <label class="label cursor-pointer">
            <span class="label-text">Apply to Symbol Group (Underlying)</span>
            <input type="checkbox" id="is_group_rule" class="checkbox checkbox-primary" />
        </label>
        <label class="label">
            <span class="label-text-alt text-gray-500">Matches all positions starting with symbol (e.g. TCS*)</span>
        </label>
    </div>

    <div id="custom_group_info" class="alert alert-info mt-4 hidden">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span>Creating combined rule for <span id="group_count">0</span> selected positions.</span>
    </div>

    <div id="candle_input_div" class="form-control w-full max-w-xs mt-4 hidden">
        <p class="text-sm text-gray-500">Exits if price closes below 20 EMA (Long) or above 20 EMA (Short) on 1-minute candle.</p>
        <div class="alert alert-warning shadow-lg mt-2">
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <span>Coming Soon: Candle engine integration in progress.</span>
            </div>
        </div>
    </div>

    <div class="modal-action">
      <button class="btn btn-success" onclick="saveRule()">Save</button>
    </div>
  </div>
</dialog>

<script>
let currentSymbol = '';
let currentExchange = '';
let currentProduct = '';
let selectedSymbols = [];

function openRuleModal(symbol, exchange, product) {
    currentSymbol = symbol;
    currentExchange = exchange;
    currentProduct = product;
    selectedSymbols = []; // Clear selection for individual rule

    document.getElementById('modal_symbol').innerText = symbol;
    document.getElementById('group_checkbox_div').classList.remove('hidden');
    document.getElementById('custom_group_info').classList.add('hidden');
    document.getElementById('is_group_rule').checked = false;
    document.getElementById('rule_modal').showModal();
}

function openGroupModal() {
    // Collect selected
    selectedSymbols = Array.from(document.querySelectorAll('.pos-checkbox:checked')).map(cb => cb.value);

    currentSymbol = 'CUSTOM_GROUP';
    currentExchange = 'NSE'; // Default
    currentProduct = 'MIS'; // Default

    document.getElementById('modal_symbol').innerText = 'Selected Group';
    document.getElementById('group_checkbox_div').classList.add('hidden');
    document.getElementById('custom_group_info').classList.remove('hidden');
    document.getElementById('group_count').innerText = selectedSymbols.length;

    // Auto-check group rule for visual consistency (though handled by included_positions)
    document.getElementById('is_group_rule').checked = true;

    document.getElementById('rule_modal').showModal();
}

function toggleAll(source) {
    document.querySelectorAll('.pos-checkbox').forEach(cb => {
        cb.checked = source.checked;
    });
    updateSelection();
}

function updateSelection() {
    const count = document.querySelectorAll('.pos-checkbox:checked').length;
    document.getElementById('selected-count').innerText = count;
    if (count > 1) {
        document.getElementById('group-action-btn').classList.remove('hidden');
    } else {
        document.getElementById('group-action-btn').classList.add('hidden');
    }
}

function toggleInputs() {
    const type = document.getElementById('exit_type').value;
    if (type === 'TOTAL_LOSS') {
        document.getElementById('loss_input_div').classList.remove('hidden');
        document.getElementById('candle_input_div').classList.add('hidden');
    } else {
        document.getElementById('loss_input_div').classList.add('hidden');
        document.getElementById('candle_input_div').classList.remove('hidden');
    }
}

async function saveRule() {
    const type = document.getElementById('exit_type').value;
    const maxLoss = document.getElementById('max_loss').value;
    const targetProfit = document.getElementById('target_profit').value;
    let isGroupRule = document.getElementById('is_group_rule').checked;

    // If using custom selection, force group rule
    if (selectedSymbols.length > 0) {
        isGroupRule = true;
    }

    const payload = {
        symbol: currentSymbol,
        exchange: currentExchange,
        product: currentProduct,
        exit_type: type,
        max_loss: maxLoss,
        target_profit: targetProfit,
        is_group_rule: isGroupRule,
        included_positions: selectedSymbols.length > 0 ? selectedSymbols : null,
        candle_condition: type === 'CANDLE_CLOSE' ? { indicator: 'EMA', period: 20 } : null
    };

    const res = await fetchWithCSRF("{{ url_for('management_bp.add_rule_route') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });

    if (res.ok) {
        window.location.reload();
    } else {
        const data = await res.json();
        showToast('Failed to save rule: ' + (data.message || 'Unknown error'), 'error');
    }
}

async function deleteRule(id) {
    if(!confirm('Are you sure?')) return;

    const res = await fetchWithCSRF("{{ url_for('management_bp.delete_rule_route') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({rule_id: id})
    });

    if (res.ok) {
        window.location.reload();
    } else {
        const data = await res.json();
        showToast('Failed to delete rule: ' + (data.message || 'Unknown error'), 'error');
    }
}
</script>
{% endblock %}
